---
import Bubbles from 'src/components/bubbles.astro';

const { transition, is_first, is_last, index, background, prev, next, animation} = Astro.props;
const svg_id = `#${transition}-${background}${background === 'loud' ? `-${next?.background}` : ''}`;
const set_transition = transition && !is_last;
const set_prev = !is_first && prev.background !== 'loud';
---
<style lang="scss" is:global>
  $transition_swoosh: 12.5%;
  $transition_curve: 6.6%;

  [data-layout-section] {
    position: relative;

    &.section--primary {
      background: $color_primary;
    }

    &.section--secondary {
      background: $color_secondary;
    }

    &.section--loud {
      background: linear-gradient(0deg, $color_grad_1A, $color_grad_1B);
      margin-bottom: 0!important;

      .svg[data-svg-transition] {
        transform: translateY(1px);
      }
    }

    &.section--swoosh {
      margin-bottom: -($transition_swoosh);
    }

    &.section--curve {
      margin-bottom: -($transition_curve);
    }

    > .content {
      padding-left: $layout_gutter;
      padding-right: $layout_gutter;
      position: relative;
      z-index: 1;

      &--prev-curve {
        @extend .content;
        padding-top: $transition_curve;
      }
      &--prev-swoosh {
        @extend .content;
        padding-top: $transition_swoosh;
      }
      &--prev-none {
        @extend .content;
      }
    }

    > .svg[data-svg-transition] {
      width: 100%;
      height: 0;
      position: relative;
      z-index: $zindex_background;
      padding-bottom: 0;

      svg {
        position: absolute; 
        height: 100%; 
        width: 100%; 
        left: 0; 
        top: 0;
      }
    }

    .svg--curve[data-svg-transition] {
      padding-bottom: $transition_curve;
    }

    .svg--swoosh[data-svg-transition] {
      padding-bottom: $transition_swoosh;
    }
  }
</style>

<section
  data-layout-section
  data-index={ index }
  data-animate={ animation }
  class:list={[
    `section--${background}`,
    {[`section--${transition}`]: set_transition},
    {[`section--animate`]: animation}
  ]}
>
  <div class={`content--prev-${set_prev ? prev.transition : 'none'}`}>
    <slot />
  </div>
  { background === 'loud' && (
    <Bubbles />
  )}
  { set_transition && (
    <div class:list={[`svg`,`svg--${transition}`]} data-svg-transition>
      <svg>
        <use xlink:href={svg_id}></use>
      </svg>
    </div>
  )}
</section>

<script>
  const sectionAnimation = document.querySelectorAll('[data-animate]');
  const hasObserverSupport = !!window.IntersectionObserver
  if (sectionAnimation && hasObserverSupport) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        console.log(entry);
        if (entry.isIntersecting) {
          entry.target.classList.add('animate');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0, root: null, rootMargin: '-5% 0% -5% 0%' });
    [...sectionAnimation].forEach(section => observer.observe(section));
  }
</script>
